<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="project-category-data.html">
<link rel="import" href="project-common-styles.html">

<link rel="import" href="elements/item-card.html">

<dom-module id="project-list">

  <template>

    <style include="project-common-styles">

      :host {
        display: block;
        position: relative;
        margin: 50px 0;
        --app-grid-columns: 5;
        --app-grid-gutter: 8px;
        @apply --layout-vertical;
        @apply --layout-center;
      }

      .pagination {
        margin: 20px 0;
      }

      .bar_progress  {
        position: absolute;
        left: 0;
        bottom: 0;
        width: 100%;
        border-radius: 0px 0px 3px 3px;
        --paper-progress-active-color: var(--paper-light-blue-600);
        --paper-progress-secondary-color: var(--paper-light-blue-600);
      }

      @media (max-width: 900px) {
        :host {
          --app-grid-columns: 3;
        }
      }
      @media (max-width: 500px) {
        :host {
          --app-grid-columns: 1;
        }
      }

    </style>

    <!-- L'éléments app-route fournit le nom de la catégorie. -->
    <app-route
        route="[[route]]"
        pattern="/:category"
        data="{{routeData}}"></app-route>

    <!-- Ajax qui permet de consulter l'API YouTube -->
    <iron-ajax
      id="ajax"
      url="https://www.googleapis.com/youtube/v3/search"
      handle-as="json"
      on-response="_handleResponse"
      debounce-duration="300">
    </iron-ajax>

    <!--
      project-category-data provides the category data for a given category name.
    -->
    <project-category-data
        id="categoryData"
        category-name="[[routeData.category]]"
        category="{{category}}"
        failure="{{failure}}"></project-category-data>

    <div class="app-grid">
      <!-- Looper l'array obtenu à partir de la requête à l'API YouTube -->
      <template is="dom-repeat" items="{{youtube}}" as="video">
        <item-card
          url="[[_getItemHref(video.id.videoId)]]"
          image="[[video.snippet.thumbnails.high.url]]"
          title="[[video.snippet.title]]"
          date="[[video.snippet.publishedAt]]"
          description="[[video.snippet.description]]"
          channel-id="[[video.snippet.channelId]]"
          channel-title="[[video.snippet.channelTitle]]" >
        </item-card>
      </template>
    </div>

    <div class="pagination layout horizontal center-center">
      <paper-button raised on-tap="_prevPageLoad" disabled$="[[!prevPage]]">
        Précédent
        <paper-progress class="bar_progress" hidden$="[[!_inProgressPrev]]" disabled$="[[!_inProgress]]" indeterminate></paper-progress>
      </paper-button>
      <paper-button raised on-tap='_nextPageLoad' disabled$="[[!nextPage]]">
        Suivant
        <paper-progress class="bar_progress" hidden$="[[!_inProgressNext]]" disabled$="[[!_inProgress]]" indeterminate></paper-progress>
      </paper-button>
    </div>

  </template>

  <script>

    class ProjectList extends Polymer.Element {

      static get is() { return 'project-list'; }

      static get properties() { return {

        category: Object,

        route: Object,

        routeData: Object,

        youtube: Array,

        /**
         * Valeur de la page précédent dans la requête de l'API YouTube.
         *
         * @type {String}
         * @default ''
         */
        prevPage: {
          type: String,
          value: ''
        },

        /**
         * Valeur de la page suivant dans la requête de l'API YouTube.
         *
         * @type {String}
         * @default ''
         */
        nextPage: {
          type: String,
          value: ''
        },

        /**
         * Indique si le processus de chargement de la page précédent est en cours.
         *
         * @type {Boolean}
         * @default false
         */
        _inProgressPrev: {
          type: Boolean,
          value: false
        },

        /**
         * Indique si le processus de chargement de la page suivant est en cours.
         *
         * @type {Boolean}
         * @default false
         */
        _inProgressNext: {
          type: Boolean,
          value: false
        },

        visible: {
          type: Boolean,
          value: false
        },

        failure: Boolean

      }}

      static get observers() { return [
        '_categoryChanged(category, visible)'
      ]}

      connectedCallback() {
        super.connectedCallback();
        this.isAttached = true;
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this.isAttached = false;
      }

      _getListItems(items) {
        // Return placeholder items when the items haven't loaded yet.
        return items || [{},{},{},{},{},{},{},{},{},{}];
      }

      _getItemHref(videoId) {
        // En renvoyant null lorsque `videoId` n'est pas défini, l'attribut href
        // ne sera pas défini et le lien sera désactivé.
        return videoId ? ['/detail', this.category.name, videoId].join('/') : null;
      }

      _getPluralizedQuantity(quantity) {
        if (!quantity) {
          return '';
        }
        let pluralizedQ = quantity === 1 ? 'item' : 'items';
        return  '(' + quantity + ' ' + pluralizedQ + ')';
      }

      _categoryChanged(category, visible) {
        if (!visible) {
          return;
        }
        this._changeSectionDebouncer = Polymer.Debouncer.debounce(this._changeSectionDebouncer,
          Polymer.Async.microTask, () => {
            if (category) {
              // Notify the category and the page's title
              this.dispatchEvent(new CustomEvent('change-section', {
                bubbles: true, composed: true, detail: {
                  category: category.name,
                  title: category.title
                }}));

              // Lorsque la catégorie change, une nouvelle requête est lancée
              // sur l'API YouTube avec l'id de la catégorie
              this.$.ajax.params = {
                part: "snippet",
                key: "AIzaSyBNZJJG60vZVode3qiREesllCTg8a3r8lw",
                type: "video",
                videoCategoryId: this.category.id
              };
              this.$.ajax.generateRequest();
            } else {
              this.dispatchEvent(new CustomEvent('show-invalid-url-warning', {
                bubbles: true, composed: true}));
            }
          });
      }

      _handleResponse(data) {
        this._inProgressPrev = false;
        this._inProgressNext = false;

        // Handler la reponse de la requête ajax.
        this.prevPage = data.detail.response.prevPageToken
        this.nextPage = data.detail.response.nextPageToken;

        this.youtube = data.detail.response.items;
      }

      _prevPageLoad() {
        this._inProgressPrev = true;

        // Remplacez le token de la valeur pageToken par le token de la page précédente
        this.$.ajax.params.pageToken = this.prevPage;
        this.$.ajax.generateRequest();
      }

      _nextPageLoad() {
        this._inProgressNext = true;

        // Remplacez le token de la valeur pageToken par le token de la page suivant
        this.$.ajax.params.pageToken = this.nextPage;
        this.$.ajax.generateRequest();
      }

    }

    customElements.define(ProjectList.is, ProjectList);

  </script>

</dom-module>
